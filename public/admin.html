<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员后台 — IELTS 评审系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 4px 16px rgba(0, 0, 0, 0.04);
        }

        .badge-active {
            background: #dcfce7;
            color: #166534;
        }

        .badge-expired {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-unlimited {
            background: #ede9fe;
            color: #5b21b6;
        }

        .badge-limited {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-exhausted {
            background: #fee2e2;
            color: #991b1b;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            width: 100%;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(2px);
        }

        .credential-box {
            font-family: 'Courier New', monospace;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen">

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-56 bg-indigo-900 text-white flex flex-col flex-shrink-0">
            <div class="p-5 border-b border-indigo-800">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-600 p-2 rounded-lg"><i class="fa-solid fa-people-arrows"></i></div>
                    <div>
                        <div class="font-bold text-sm">IELTS Reviewer</div>
                        <div class="text-indigo-400 text-xs">管理员后台</div>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-3 space-y-1">
                <button onclick="showSection('api-settings')"
                    class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-indigo-200 hover:bg-indigo-800 hover:text-white transition-colors text-left">
                    <i class="fa-solid fa-key w-4"></i> AI API 配置
                </button>
                <button onclick="showSection('users')"
                    class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-indigo-200 hover:bg-indigo-800 hover:text-white transition-colors text-left">
                    <i class="fa-solid fa-users w-4"></i> 用户管理
                </button>
            </nav>
            <div class="p-3 border-t border-indigo-800">
                <div class="text-xs text-indigo-400 px-3 mb-2" id="adminName">管理员</div>
                <button onclick="logout()"
                    class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-indigo-300 hover:bg-indigo-800 hover:text-white transition-colors w-full">
                    <i class="fa-solid fa-right-from-bracket"></i> 退出登录
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-8">

            <!-- API Settings -->
            <section id="section-api-settings">
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-800">AI API 配置</h2>
                    <p class="text-gray-500 text-sm mt-1">配置用于批改作文的 AI 接口，所有用户共用此配置</p>
                </div>
                <div class="card p-6 max-w-xl">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">API Key</label>
                            <div class="relative">
                                <input type="password" id="cfg-apiKey" placeholder="sk-...">
                                <button onclick="togglePwd('cfg-apiKey')"
                                    class="absolute right-3 top-2 text-gray-400 hover:text-gray-600">
                                    <i class="fa-solid fa-eye text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">API Base URL</label>
                            <input type="text" id="cfg-apiBase" placeholder="https://api.openai.com/v1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">模型名称</label>
                            <input type="text" id="cfg-model" placeholder="gpt-4o-mini">
                        </div>
                        <button onclick="saveSettings()"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-floppy-disk"></i> 保存配置
                        </button>
                        <div id="settingsSaved" class="hidden text-green-600 text-sm flex items-center gap-1.5">
                            <i class="fa-solid fa-circle-check"></i> 已保存
                        </div>
                    </div>
                </div>
            </section>

            <!-- Users Section -->
            <section id="section-users" class="hidden">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">用户管理</h2>
                        <p class="text-gray-500 text-sm mt-1">生成账户、查看密码、设置批改次数或订阅时长</p>
                    </div>
                    <button onclick="openGenerateModal()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-plus"></i> 生成新账户
                    </button>
                </div>

                <div class="card overflow-hidden">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50 border-b border-gray-100">
                                <th class="text-left px-5 py-3.5 font-semibold text-gray-600">用户名</th>
                                <th class="text-left px-5 py-3.5 font-semibold text-gray-600">显示名</th>
                                <th class="text-left px-5 py-3.5 font-semibold text-gray-600">批改次数</th>
                                <th class="text-left px-5 py-3.5 font-semibold text-gray-600">订阅状态</th>
                                <th class="text-left px-5 py-3.5 font-semibold text-gray-600">创建时间</th>
                                <th class="px-5 py-3.5 text-right font-semibold text-gray-600">操作</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr>
                                <td colspan="6" class="text-center py-12 text-gray-400"><i
                                        class="fa-solid fa-spinner fa-spin mr-2"></i>加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

        </main>
    </div>

    <!-- ── Generate User Modal ─────────────────────────────────────────────────── -->
    <div id="generateModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                <h3 class="font-bold text-gray-800">生成新账户</h3>
                <button onclick="closeModal('generateModal')" class="text-gray-400 hover:text-gray-600 text-lg"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1.5">批改次数上限</label>
                    <div class="flex gap-2">
                        <select id="gen-limitType" onchange="toggleLimitInput()" style="width:auto; flex-shrink:0">
                            <option value="unlimited">无限制</option>
                            <option value="limited">限制次数</option>
                        </select>
                        <input type="number" id="gen-maxReviews" placeholder="次数" class="hidden flex-1" min="1"
                            value="10">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1.5">订阅到期时间</label>
                    <div class="flex gap-2">
                        <select id="gen-subType" onchange="toggleSubInput()" style="width:auto; flex-shrink:0">
                            <option value="forever">永不过期</option>
                            <option value="date">设置到期日</option>
                        </select>
                        <input type="date" id="gen-subEnd" class="hidden flex-1">
                    </div>
                </div>
                <button onclick="generateUser()"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> 生成账户
                </button>
            </div>

            <!-- Generated Result -->
            <div id="generatedResult" class="hidden px-6 pb-6">
                <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-4">
                    <p class="text-sm font-semibold text-indigo-700 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-circle-check text-green-500"></i> 账户已生成，请妥善保存以下信息
                    </p>
                    <div class="space-y-2">
                        <div
                            class="flex items-center justify-between bg-white rounded-lg px-3 py-2 border border-indigo-100">
                            <div class="min-w-0">
                                <div class="text-xs text-gray-400 mb-0.5">用户名</div>
                                <div id="res-username" class="credential-box text-gray-800 text-sm"></div>
                            </div>
                            <button onclick="copyEl('res-username')"
                                class="ml-3 text-indigo-500 hover:text-indigo-700 flex-shrink-0 text-sm px-2 py-1 rounded hover:bg-indigo-100 transition-colors">
                                <i class="fa-solid fa-copy"></i>
                            </button>
                        </div>
                        <div
                            class="flex items-center justify-between bg-white rounded-lg px-3 py-2 border border-indigo-100">
                            <div class="min-w-0">
                                <div class="text-xs text-gray-400 mb-0.5">密码</div>
                                <div id="res-password" class="credential-box text-gray-800 text-sm"></div>
                            </div>
                            <button onclick="copyEl('res-password')"
                                class="ml-3 text-indigo-500 hover:text-indigo-700 flex-shrink-0 text-sm px-2 py-1 rounded hover:bg-indigo-100 transition-colors">
                                <i class="fa-solid fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ── Edit User Modal ────────────────────────────────────────────────────── -->
    <div id="editModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="font-bold text-gray-800">编辑用户</h3>
                    <p class="text-xs text-gray-400 mt-0.5" id="edit-usernameLabel"></p>
                </div>
                <button onclick="closeModal('editModal')" class="text-gray-400 hover:text-gray-600 text-lg"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="edit-userId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1.5">显示名</label>
                    <input type="text" id="edit-displayName" placeholder="显示名">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1.5">批改次数上限（-1 = 无限）</label>
                    <input type="number" id="edit-maxReviews" min="-1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1.5">订阅到期时间（留空 = 永不过期）</label>
                    <input type="date" id="edit-subEnd">
                </div>
                <div id="editError" class="hidden text-red-500 text-sm"></div>
                <div class="flex gap-3">
                    <button onclick="saveUser()"
                        class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-lg font-medium transition-colors">
                        保存
                    </button>
                    <button onclick="closeModal('editModal')"
                        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2.5 rounded-lg font-medium transition-colors">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ── Reset Password Modal ───────────────────────────────────────────────── -->
    <div id="resetModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm">
            <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                <h3 class="font-bold text-gray-800">重置密码</h3>
                <button onclick="closeModal('resetModal')" class="text-gray-400 hover:text-gray-600 text-lg"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6">
                <input type="hidden" id="reset-userId">
                <p class="text-sm text-gray-600 mb-4">
                    将为用户 <strong id="reset-usernameLabel" class="text-gray-800"></strong> 生成一个新的随机密码，旧密码将立即失效。
                </p>

                <!-- Before reset -->
                <div id="resetBefore">
                    <button onclick="doResetPassword()"
                        class="w-full bg-amber-500 hover:bg-amber-600 text-white py-2.5 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-key"></i> 确认重置密码
                    </button>
                </div>

                <!-- After reset — show new password -->
                <div id="resetAfter" class="hidden">
                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                        <p class="text-sm font-semibold text-amber-700 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-circle-check text-green-500"></i> 密码已重置，请记录新密码
                        </p>
                        <div
                            class="flex items-center justify-between bg-white rounded-lg px-3 py-2 border border-amber-100">
                            <div class="min-w-0">
                                <div class="text-xs text-gray-400 mb-0.5">新密码</div>
                                <div id="reset-newPassword" class="credential-box text-gray-800 text-sm"></div>
                            </div>
                            <button onclick="copyEl('reset-newPassword')"
                                class="ml-3 text-amber-600 hover:text-amber-800 flex-shrink-0 text-sm px-2 py-1 rounded hover:bg-amber-100 transition-colors">
                                <i class="fa-solid fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ── Delete Confirm Modal ───────────────────────────────────────────────── -->
    <div id="deleteModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-600">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800">删除用户</h3>
                        <p class="text-xs text-gray-400">此操作不可撤销</p>
                    </div>
                </div>
                <input type="hidden" id="delete-userId">
                <p class="text-sm text-gray-600 mb-6">
                    确定要删除用户 <strong id="delete-usernameLabel" class="text-gray-800"></strong> 吗？
                    该用户的所有批改记录和聊天历史也将被永久删除。
                </p>
                <div class="flex gap-3">
                    <button onclick="doDeleteUser()"
                        class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2.5 rounded-lg font-medium transition-colors">
                        确认删除
                    </button>
                    <button onclick="closeModal('deleteModal')"
                        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2.5 rounded-lg font-medium transition-colors">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        // Store users data keyed by id for safe access without JSON in onclick
        const usersMap = {};

        // ── Auth check ──────────────────────────────────────────────────────────
        async function init() {
            const res = await fetch('/api/me');
            if (!res.ok) { window.location.href = '/'; return; }
            currentUser = await res.json();
            if (!currentUser.is_admin) { window.location.href = '/app.html'; return; }
            document.getElementById('adminName').textContent = currentUser.display_name || currentUser.username;
            loadSettings();
            showSection('api-settings');
        }

        // ── Navigation ──────────────────────────────────────────────────────────
        function showSection(name) {
            document.querySelectorAll('section[id^="section-"]').forEach(s => s.classList.add('hidden'));
            document.getElementById('section-' + name).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-indigo-800', 'text-white'));
            const btns = document.querySelectorAll('.nav-btn');
            const idx = name === 'api-settings' ? 0 : 1;
            btns[idx].classList.add('bg-indigo-800', 'text-white');
            if (name === 'users') loadUsers();
        }

        // ── Settings ────────────────────────────────────────────────────────────
        async function loadSettings() {
            const res = await fetch('/api/admin/settings');
            const data = await res.json();
            document.getElementById('cfg-apiKey').value = data.apiKey || '';
            document.getElementById('cfg-apiBase').value = data.apiBase || 'https://api.openai.com/v1';
            document.getElementById('cfg-model').value = data.model || 'gpt-4o-mini';
        }

        async function saveSettings() {
            const res = await fetch('/api/admin/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    apiKey: document.getElementById('cfg-apiKey').value.trim(),
                    apiBase: document.getElementById('cfg-apiBase').value.trim(),
                    model: document.getElementById('cfg-model').value.trim()
                })
            });
            if (res.ok) {
                const el = document.getElementById('settingsSaved');
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('hidden'), 2000);
            }
        }

        function togglePwd(id) {
            const el = document.getElementById(id);
            el.type = el.type === 'password' ? 'text' : 'password';
        }

        // ── Users ───────────────────────────────────────────────────────────────
        async function loadUsers() {
            const res = await fetch('/api/admin/users');
            const users = await res.json();
            const tbody = document.getElementById('usersTable');

            // Clear and rebuild usersMap
            Object.keys(usersMap).forEach(k => delete usersMap[k]);

            const nonAdmins = users.filter(u => !u.is_admin);
            if (!nonAdmins.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-12 text-gray-400">暂无用户，点击"生成新账户"创建</td></tr>';
                return;
            }

            nonAdmins.forEach(u => usersMap[u.id] = u);

            const now = new Date();
            tbody.innerHTML = nonAdmins.map(u => {
                const subEnd = u.subscription_end ? new Date(u.subscription_end) : null;
                const subBadge = !subEnd
                    ? '<span class="badge-active text-xs px-2 py-0.5 rounded-full font-medium">永久</span>'
                    : now > subEnd
                        ? `<span class="badge-expired text-xs px-2 py-0.5 rounded-full font-medium">已过期 ${u.subscription_end.slice(0, 10)}</span>`
                        : `<span class="badge-active text-xs px-2 py-0.5 rounded-full font-medium">有效至 ${u.subscription_end.slice(0, 10)}</span>`;

                const isExhausted = u.max_reviews !== -1 && u.used_reviews >= u.max_reviews;
                const reviewBadge = u.max_reviews === -1
                    ? '<span class="badge-unlimited text-xs px-2 py-0.5 rounded-full font-medium">无限制</span>'
                    : isExhausted
                        ? `<span class="badge-exhausted text-xs px-2 py-0.5 rounded-full font-medium">已用完 ${u.used_reviews}/${u.max_reviews}</span>`
                        : `<span class="badge-limited text-xs px-2 py-0.5 rounded-full font-medium">${u.used_reviews} / ${u.max_reviews}</span>`;

                return `<tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
          <td class="px-5 py-4 font-mono text-sm text-gray-700">${u.username}</td>
          <td class="px-5 py-4 text-gray-700">${u.display_name || '<span class="text-gray-300">—</span>'}</td>
          <td class="px-5 py-4">${reviewBadge}</td>
          <td class="px-5 py-4">${subBadge}</td>
          <td class="px-5 py-4 text-gray-400 text-xs">${u.created_at.slice(0, 10)}</td>
          <td class="px-5 py-4">
            <div class="flex gap-1 justify-end">
              <button onclick="openEditModal('${u.id}')" title="编辑"
                class="text-indigo-600 hover:text-indigo-800 text-xs px-2.5 py-1.5 rounded-lg hover:bg-indigo-50 transition-colors">
                <i class="fa-solid fa-pen-to-square"></i> 编辑
              </button>
              <button onclick="openResetModal('${u.id}')" title="重置密码"
                class="text-amber-600 hover:text-amber-800 text-xs px-2.5 py-1.5 rounded-lg hover:bg-amber-50 transition-colors">
                <i class="fa-solid fa-key"></i> 密码
              </button>
              <button onclick="openDeleteModal('${u.id}')" title="删除"
                class="text-red-500 hover:text-red-700 text-xs px-2.5 py-1.5 rounded-lg hover:bg-red-50 transition-colors">
                <i class="fa-solid fa-trash"></i> 删除
              </button>
            </div>
          </td>
        </tr>`;
            }).join('');
        }

        // ── Generate User Modal ─────────────────────────────────────────────────
        function openGenerateModal() {
            document.getElementById('generatedResult').classList.add('hidden');
            document.getElementById('gen-limitType').value = 'unlimited';
            document.getElementById('gen-maxReviews').classList.add('hidden');
            document.getElementById('gen-subType').value = 'forever';
            document.getElementById('gen-subEnd').classList.add('hidden');
            document.getElementById('generateModal').classList.remove('hidden');
        }

        function toggleLimitInput() {
            document.getElementById('gen-maxReviews').classList.toggle('hidden',
                document.getElementById('gen-limitType').value !== 'limited');
        }

        function toggleSubInput() {
            document.getElementById('gen-subEnd').classList.toggle('hidden',
                document.getElementById('gen-subType').value !== 'date');
        }

        async function generateUser() {
            const limitType = document.getElementById('gen-limitType').value;
            const subType = document.getElementById('gen-subType').value;
            const max_reviews = limitType === 'unlimited' ? -1 : parseInt(document.getElementById('gen-maxReviews').value) || 10;
            const subscription_end = subType === 'date' ? (document.getElementById('gen-subEnd').value || null) : null;

            const res = await fetch('/api/admin/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ max_reviews, subscription_end })
            });
            const data = await res.json();

            document.getElementById('res-username').textContent = data.username;
            document.getElementById('res-password').textContent = data.password;
            document.getElementById('generatedResult').classList.remove('hidden');
            loadUsers();
        }

        // ── Edit User Modal ─────────────────────────────────────────────────────
        function openEditModal(userId) {
            const u = usersMap[userId];
            if (!u) return;
            document.getElementById('edit-userId').value = u.id;
            document.getElementById('edit-usernameLabel').textContent = u.username;
            document.getElementById('edit-displayName').value = u.display_name || '';
            document.getElementById('edit-maxReviews').value = u.max_reviews;
            document.getElementById('edit-subEnd').value = u.subscription_end ? u.subscription_end.slice(0, 10) : '';
            document.getElementById('editError').classList.add('hidden');
            document.getElementById('editModal').classList.remove('hidden');
        }

        async function saveUser() {
            const id = document.getElementById('edit-userId').value;
            const res = await fetch(`/api/admin/users/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    display_name: document.getElementById('edit-displayName').value,
                    max_reviews: parseInt(document.getElementById('edit-maxReviews').value),
                    subscription_end: document.getElementById('edit-subEnd').value || null
                })
            });
            if (res.ok) { closeModal('editModal'); loadUsers(); }
            else {
                const data = await res.json();
                document.getElementById('editError').textContent = data.error;
                document.getElementById('editError').classList.remove('hidden');
            }
        }

        // ── Reset Password Modal ────────────────────────────────────────────────
        function openResetModal(userId) {
            const u = usersMap[userId];
            if (!u) return;
            document.getElementById('reset-userId').value = u.id;
            document.getElementById('reset-usernameLabel').textContent = u.username;
            document.getElementById('resetBefore').classList.remove('hidden');
            document.getElementById('resetAfter').classList.add('hidden');
            document.getElementById('resetModal').classList.remove('hidden');
        }

        async function doResetPassword() {
            const id = document.getElementById('reset-userId').value;
            const res = await fetch(`/api/admin/users/${id}/reset-password`, { method: 'POST' });
            const data = await res.json();
            if (!res.ok) { alert(data.error); return; }
            document.getElementById('reset-newPassword').textContent = data.password;
            document.getElementById('resetBefore').classList.add('hidden');
            document.getElementById('resetAfter').classList.remove('hidden');
        }

        // ── Delete Modal ────────────────────────────────────────────────────────
        function openDeleteModal(userId) {
            const u = usersMap[userId];
            if (!u) return;
            document.getElementById('delete-userId').value = u.id;
            document.getElementById('delete-usernameLabel').textContent = u.username;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        async function doDeleteUser() {
            const id = document.getElementById('delete-userId').value;
            const res = await fetch(`/api/admin/users/${id}`, { method: 'DELETE' });
            if (res.ok) { closeModal('deleteModal'); loadUsers(); }
            else { const d = await res.json(); alert(d.error); }
        }

        // ── Helpers ─────────────────────────────────────────────────────────────
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function copyEl(id) {
            const text = document.getElementById(id).textContent.trim();
            navigator.clipboard.writeText(text).then(() => {
                const el = document.getElementById(id);
                const orig = el.textContent;
                el.textContent = '✓ 已复制';
                setTimeout(() => el.textContent = orig, 1200);
            });
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(el => {
            el.addEventListener('click', (e) => {
                if (e.target === el) el.classList.add('hidden');
            });
        });

        init();
    </script>
</body>

</html>