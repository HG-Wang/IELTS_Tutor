<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雅思写作 — 多智能体评审系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .typing-cursor::after {
            content: '|';
            animation: blink 1s step-start infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        .agent-card {
            transition: all 0.3s ease;
        }

        .agent-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .debate-bubble {
            padding: 1rem;
            border-radius: 1rem;
            position: relative;
            max-width: 80%;
        }

        .debate-bubble.left {
            background-color: #eff6ff;
            border-top-left-radius: 0;
            margin-right: auto;
        }

        .debate-bubble.right {
            background-color: #fff7ed;
            border-top-right-radius: 0;
            margin-left: auto;
        }

        .session-item {
            transition: all 0.15s;
        }

        .session-item:hover {
            background: #f1f5f9;
        }

        .session-item.active {
            background: #e0e7ff;
            border-left: 3px solid #6366f1;
        }

        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3 {
            font-weight: 700;
            margin: 1em 0 0.5em;
        }

        .markdown-body p {
            margin: 0.5em 0;
        }

        .markdown-body ul,
        .markdown-body ol {
            padding-left: 1.5em;
            margin: 0.5em 0;
        }

        .markdown-body li {
            margin: 0.25em 0;
        }

        .markdown-body strong {
            font-weight: 700;
        }

        .markdown-body code {
            background: #f1f5f9;
            padding: 0.1em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .markdown-body blockquote {
            border-left: 3px solid #e2e8f0;
            padding-left: 1em;
            color: #64748b;
            margin: 0.5em 0;
        }

        .markdown-body hr {
            border: none;
            border-top: 1px solid #e2e8f0;
            margin: 1em 0;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header
        class="bg-white border-b border-gray-200 px-5 py-3 flex justify-between items-center shadow-sm z-10 flex-shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 text-white p-2 rounded-lg">
                <i class="fa-solid fa-people-arrows"></i>
            </div>
            <h1 class="text-lg font-bold text-gray-800">IELTS Multi-Agent Reviewer</h1>
        </div>
        <div class="flex items-center gap-4">
            <!-- Usage info -->
            <div id="usageInfo" class="text-xs text-gray-500 hidden">
                <span id="usageText"></span>
            </div>
            <!-- User info -->
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-bold text-sm"
                    id="userAvatar">?</div>
                <span class="text-sm font-medium text-gray-700" id="userName">加载中...</span>
            </div>
            <button onclick="openProfileModal()"
                class="text-gray-500 hover:text-gray-700 text-sm px-3 py-1.5 rounded-lg hover:bg-gray-100 transition-colors">
                <i class="fa-solid fa-gear"></i>
            </button>
            <button onclick="logout()"
                class="text-gray-500 hover:text-red-600 text-sm px-3 py-1.5 rounded-lg hover:bg-red-50 transition-colors">
                <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">

        <!-- Left Sidebar: History + Input -->
        <aside class="w-72 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">

            <!-- New Session Button -->
            <div class="p-3 border-b border-gray-100">
                <button onclick="newSession()"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-xl transition-all flex items-center justify-center gap-2 text-sm shadow-sm">
                    <i class="fa-solid fa-plus"></i> 新建批改
                </button>
            </div>

            <!-- Session History -->
            <div class="flex-1 overflow-y-auto">
                <div class="px-3 pt-3 pb-1">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">历史记录</p>
                </div>
                <div id="sessionList" class="px-2 pb-2 space-y-0.5">
                    <div class="text-center py-8 text-gray-400 text-sm"><i class="fa-solid fa-spinner fa-spin"></i>
                    </div>
                </div>
            </div>

            <!-- Essay Input Area -->
            <div class="border-t border-gray-200 p-3 flex flex-col gap-2" style="max-height: 55vh; overflow-y: auto;">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1">题目 (Task 2)</label>
                    <textarea id="topic" rows="3"
                        class="w-full p-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 text-sm resize-none"
                        placeholder="输入雅思写作题目..."></textarea>
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-semibold text-gray-500 mb-1">你的文章</label>
                    <textarea id="essay" rows="8"
                        class="w-full p-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 text-sm resize-none font-mono"
                        placeholder="在此粘贴你的作文..."></textarea>
                </div>
                <button onclick="startReview()" id="submitBtn"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 rounded-xl transition-all shadow-sm flex justify-center items-center gap-2 text-sm">
                    <i class="fa-solid fa-gavel"></i> 开始多方评审
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 bg-gray-50 flex flex-col overflow-hidden relative">

            <div id="processArea" class="flex-1 overflow-y-auto p-6 space-y-6 pb-32">

                <!-- Welcome State -->
                <div id="welcomeState" class="text-center mt-24 opacity-40">
                    <i class="fa-solid fa-robot text-6xl mb-4 text-gray-300"></i>
                    <p class="text-xl text-gray-500">请输入题目和文章，点击开始评审</p>
                    <p class="text-sm mt-2 text-gray-400">系统将召唤 3 位 AI 专家为您服务</p>
                </div>

                <!-- Agent A -->
                <div id="agentA"
                    class="agent-card hidden bg-white rounded-xl border-l-4 border-blue-500 shadow-sm p-6 max-w-4xl mx-auto">
                    <div class="flex items-center gap-3 mb-4 border-b border-gray-100 pb-3">
                        <div
                            class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">
                            A</div>
                        <div>
                            <h3 class="font-bold text-gray-800">Grammar Guru (语法严谨派)</h3>
                            <p class="text-xs text-gray-500">专注于 GRA (语法多样性与准确性) & LR (词汇资源)</p>
                        </div>
                        <span class="ml-auto text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded">正在分析...</span>
                    </div>
                    <div class="content text-sm text-gray-700 leading-relaxed markdown-body"></div>
                </div>

                <!-- Agent B -->
                <div id="agentB"
                    class="agent-card hidden bg-white rounded-xl border-l-4 border-orange-500 shadow-sm p-6 max-w-4xl mx-auto">
                    <div class="flex items-center gap-3 mb-4 border-b border-gray-100 pb-3">
                        <div
                            class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 font-bold">
                            B</div>
                        <div>
                            <h3 class="font-bold text-gray-800">Logic Master (逻辑思维派)</h3>
                            <p class="text-xs text-gray-500">专注于 TR (任务回应) & CC (连贯与衔接)</p>
                        </div>
                        <span class="ml-auto text-xs bg-orange-50 text-orange-600 px-2 py-1 rounded">正在分析...</span>
                    </div>
                    <div class="content text-sm text-gray-700 leading-relaxed markdown-body"></div>
                </div>

                <!-- Debate -->
                <div id="committeeDiscussion" class="hidden max-w-4xl mx-auto my-4">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600"><i
                                class="fa-solid fa-comments text-xl"></i></div>
                        <h3 class="font-bold text-gray-700">Round 2: Cross-Examination (Committee Debate)</h3>
                    </div>
                    <div id="debateContainer" class="space-y-4"></div>
                </div>

                <!-- Agent C -->
                <div id="agentC"
                    class="agent-card hidden bg-white rounded-xl border border-indigo-200 shadow-lg p-0 max-w-4xl mx-auto overflow-hidden ring-4 ring-indigo-50">
                    <div class="bg-indigo-600 text-white p-4 flex items-center gap-3">
                        <i class="fa-solid fa-scale-balanced text-xl"></i>
                        <div>
                            <h3 class="font-bold text-lg">Chief Examiner (主考官裁决)</h3>
                            <p class="text-xs opacity-90">综合 A 与 B 的意见，给出最终评分与范文</p>
                        </div>
                    </div>
                    <div class="p-6 content text-gray-800 leading-relaxed markdown-body"></div>
                </div>

            </div>

            <!-- Chat Section -->
            <div id="chatSection"
                class="bg-white border-t border-gray-200 p-4 absolute bottom-0 w-full transform translate-y-full transition-transform duration-300">
                <div class="max-w-4xl mx-auto flex gap-3">
                    <div class="flex-1 relative">
                        <input type="text" id="chatInput"
                            class="w-full border border-gray-300 rounded-xl pl-4 pr-12 py-3 focus:outline-none focus:border-indigo-500 shadow-sm text-sm"
                            placeholder="对修改意见有疑问？向主考官提问...">
                        <button onclick="sendChat()"
                            class="absolute right-2 top-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-600 p-1.5 rounded-lg transition-colors">
                            <i class="fa-solid fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal"
        class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm">
            <div class="p-5 border-b border-gray-100 flex items-center justify-between">
                <h3 class="font-bold text-gray-800">账户设置</h3>
                <button onclick="closeModal('profileModal')" class="text-gray-400 hover:text-gray-600"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-5 space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">显示名</label>
                    <input type="text" id="prof-displayName"
                        class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">原密码</label>
                    <input type="password" id="prof-oldPwd"
                        class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-400"
                        placeholder="不修改密码可留空">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">新密码</label>
                    <input type="password" id="prof-newPwd"
                        class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-400"
                        placeholder="不修改密码可留空">
                </div>
                <div id="profError" class="hidden text-red-500 text-sm"></div>
                <div id="profSuccess" class="hidden text-green-600 text-sm">✓ 保存成功</div>
                <button onclick="saveProfile()"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-xl font-medium text-sm transition-colors">
                    保存
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentSessionId = null;
        let contextHistory = [];

        // ── Init ──────────────────────────────────────────────────────────────────
        async function init() {
            const res = await fetch('/api/me');
            if (!res.ok) { window.location.href = '/'; return; }
            currentUser = await res.json();
            if (currentUser.is_admin) { window.location.href = '/admin.html'; return; }

            document.getElementById('userName').textContent = currentUser.display_name || currentUser.username;
            document.getElementById('userAvatar').textContent = (currentUser.display_name || currentUser.username)[0].toUpperCase();

            // Show usage info
            if (currentUser.max_reviews !== -1) {
                const remaining = currentUser.max_reviews - currentUser.used_reviews;
                document.getElementById('usageText').textContent = `剩余批改次数：${remaining}/${currentUser.max_reviews}`;
                document.getElementById('usageInfo').classList.remove('hidden');
            }
            if (currentUser.subscription_end) {
                const end = new Date(currentUser.subscription_end);
                const text = `订阅到期：${end.toLocaleDateString('zh-CN')}`;
                document.getElementById('usageText').textContent += (currentUser.max_reviews !== -1 ? ' | ' : '') + text;
                document.getElementById('usageInfo').classList.remove('hidden');
            }

            loadSessions();
        }

        // ── Sessions ──────────────────────────────────────────────────────────────
        async function loadSessions() {
            const res = await fetch('/api/sessions');
            const sessions = await res.json();
            const list = document.getElementById('sessionList');

            if (!sessions.length) {
                list.innerHTML = '<div class="text-center py-6 text-gray-400 text-xs">暂无历史记录</div>';
                return;
            }

            list.innerHTML = sessions.map(s => `
        <div class="session-item rounded-lg px-3 py-2.5 cursor-pointer flex items-start gap-2 group ${s.id === currentSessionId ? 'active' : ''}"
          onclick="loadSession('${s.id}')">
          <i class="fa-solid fa-file-pen text-gray-300 mt-0.5 text-xs flex-shrink-0"></i>
          <div class="flex-1 min-w-0">
            <div class="text-xs font-medium text-gray-700 truncate">${s.title || '新批改'}</div>
            <div class="text-xs text-gray-400">${new Date(s.created_at).toLocaleDateString('zh-CN')}</div>
          </div>
          <button onclick="event.stopPropagation(); deleteSession('${s.id}')"
            class="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition-all text-xs flex-shrink-0">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      `).join('');
        }

        async function newSession() {
            const res = await fetch('/api/sessions', { method: 'POST' });
            const data = await res.json();
            currentSessionId = data.id;
            contextHistory = [];

            // Reset UI
            document.getElementById('topic').value = '';
            document.getElementById('essay').value = '';
            document.getElementById('welcomeState').classList.remove('hidden');
            document.getElementById('agentA').classList.add('hidden');
            document.getElementById('agentB').classList.add('hidden');
            document.getElementById('committeeDiscussion').classList.add('hidden');
            document.getElementById('agentC').classList.add('hidden');
            document.getElementById('chatSection').style.transform = 'translateY(100%)';
            document.getElementById('debateContainer').innerHTML = '';

            loadSessions();
        }

        async function loadSession(id) {
            const res = await fetch(`/api/sessions/${id}`);
            if (!res.ok) return;
            const session = await res.json();
            currentSessionId = id;

            // Fill inputs
            document.getElementById('topic').value = session.topic || '';
            document.getElementById('essay').value = session.essay || '';

            // Restore messages
            const msgs = session.messages || [];
            const getMsg = (role) => msgs.find(m => m.role === role);

            const resA = getMsg('agentA');
            const resB = getMsg('agentB');
            const critiqueA = getMsg('critiqueA');
            const critiqueB = getMsg('critiqueB');
            const resC = getMsg('agentC');

            // Reset
            document.getElementById('welcomeState').classList.add('hidden');
            document.getElementById('agentA').classList.toggle('hidden', !resA);
            document.getElementById('agentB').classList.toggle('hidden', !resB);
            document.getElementById('committeeDiscussion').classList.toggle('hidden', !critiqueA && !critiqueB);
            document.getElementById('agentC').classList.toggle('hidden', !resC);
            document.getElementById('debateContainer').innerHTML = '';

            if (resA) document.querySelector('#agentA .content').innerHTML = marked.parse(resA.content);
            if (resB) document.querySelector('#agentB .content').innerHTML = marked.parse(resB.content);
            if (critiqueA) addDebateMessage('A', critiqueA.content);
            if (critiqueB) addDebateMessage('B', critiqueB.content);
            if (resC) {
                document.querySelector('#agentC .content').innerHTML = marked.parse(resC.content);
                // Restore chat context
                contextHistory = [
                    { role: 'system', content: '你是一个雅思写作助手，请务必全程使用中文回复。用户刚刚提交了一篇文章并获得了反馈。请用中文回答用户关于反馈的任何后续问题。' },
                    { role: 'user', content: `Topic: ${session.topic}\nEssay: ${session.essay}` },
                    { role: 'assistant', content: resC.content }
                ];
                // Restore chat messages
                const chatMsgs = msgs.filter(m => m.role === 'user' || m.role === 'assistant');
                // Skip first user/assistant pair (already in contextHistory)
                const extraMsgs = chatMsgs.slice(0);
                const cContent = document.querySelector('#agentC .content');
                for (let i = 0; i < extraMsgs.length; i += 2) {
                    const u = extraMsgs[i];
                    const a = extraMsgs[i + 1];
                    if (u && a) {
                        cContent.innerHTML += `
              <div class="mt-4 border-t pt-4">
                <p class="font-bold text-indigo-600 mb-1">Me:</p>
                <p class="bg-indigo-50 p-2 rounded text-sm mb-2">${u.content}</p>
                <p class="font-bold text-gray-800 mb-1">Examiner:</p>
                <div class="text-sm text-gray-700 markdown-body">${marked.parse(a.content)}</div>
              </div>`;
                        contextHistory.push({ role: 'user', content: u.content });
                        contextHistory.push({ role: 'assistant', content: a.content });
                    }
                }
                document.getElementById('chatSection').style.transform = 'translateY(0)';
            }

            loadSessions();
            document.getElementById('processArea').scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteSession(id) {
            if (!confirm('确定要删除这条记录吗？')) return;
            await fetch(`/api/sessions/${id}`, { method: 'DELETE' });
            if (currentSessionId === id) {
                currentSessionId = null;
                document.getElementById('welcomeState').classList.remove('hidden');
                document.getElementById('agentA').classList.add('hidden');
                document.getElementById('agentB').classList.add('hidden');
                document.getElementById('committeeDiscussion').classList.add('hidden');
                document.getElementById('agentC').classList.add('hidden');
                document.getElementById('chatSection').style.transform = 'translateY(100%)';
            }
            loadSessions();
        }

        // ── Review ────────────────────────────────────────────────────────────────
        async function startReview() {
            const topic = document.getElementById('topic').value.trim();
            const essay = document.getElementById('essay').value.trim();
            if (!essay) { alert('请先输入文章！'); return; }

            // Create session if none
            if (!currentSessionId) {
                const r = await fetch('/api/sessions', { method: 'POST' });
                const d = await r.json();
                currentSessionId = d.id;
            }

            // UI Reset
            document.getElementById('welcomeState').classList.add('hidden');
            document.getElementById('agentA').classList.remove('hidden');
            document.getElementById('agentB').classList.remove('hidden');
            document.getElementById('committeeDiscussion').classList.add('hidden');
            document.getElementById('debateContainer').innerHTML = '';
            document.getElementById('agentC').classList.add('hidden');
            document.getElementById('chatSection').style.transform = 'translateY(100%)';

            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 正在多轮评审中...';
            btn.disabled = true;

            document.querySelector('#agentA .content').innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i>Round 1: Analyzing Grammar & Vocabulary...';
            document.querySelector('#agentB .content').innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i>Round 1: Analyzing Logic & Coherence...';
            document.querySelector('#agentC .content').innerHTML = '';

            try {
                const res = await fetch('/api/review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSessionId, topic, essay })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || '批改失败');

                document.querySelector('#agentA .content').innerHTML = marked.parse(data.resA);
                document.querySelector('#agentB .content').innerHTML = marked.parse(data.resB);

                document.getElementById('committeeDiscussion').classList.remove('hidden');
                addDebateMessage('A', data.critiqueA);
                addDebateMessage('B', data.critiqueB);

                document.getElementById('agentC').classList.remove('hidden');
                document.querySelector('#agentC .content').innerHTML = marked.parse(data.resC);

                contextHistory = [
                    { role: 'system', content: '你是一个雅思写作助手，请务必全程使用中文回复。用户刚刚提交了一篇文章并获得了反馈。请用中文回答用户关于反馈的任何后续问题。' },
                    { role: 'user', content: `Topic: ${topic}\nEssay: ${essay}` },
                    { role: 'assistant', content: data.resC }
                ];
                document.getElementById('chatSection').style.transform = 'translateY(0)';

                // Refresh usage info
                const meRes = await fetch('/api/me');
                if (meRes.ok) {
                    currentUser = await meRes.json();
                    if (currentUser.max_reviews !== -1) {
                        const remaining = currentUser.max_reviews - currentUser.used_reviews;
                        document.getElementById('usageText').textContent = `剩余批改次数：${remaining}/${currentUser.max_reviews}`;
                    }
                }

                loadSessions();
            } catch (e) {
                alert('错误：' + e.message);
                document.querySelector('#agentA .content').innerHTML = '';
                document.querySelector('#agentB .content').innerHTML = '';
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-gavel"></i> 重新评审';
                btn.disabled = false;
                document.getElementById('processArea').scrollTo({ top: document.getElementById('processArea').scrollHeight, behavior: 'smooth' });
            }
        }

        // ── Debate Bubble ─────────────────────────────────────────────────────────
        function addDebateMessage(agent, content) {
            const container = document.getElementById('debateContainer');
            const isA = agent === 'A';
            const div = document.createElement('div');
            div.className = `debate-bubble ${isA ? 'left' : 'right'} border ${isA ? 'border-blue-100' : 'border-orange-100'}`;
            div.innerHTML = `
        <div class="flex items-center gap-2 mb-2 ${isA ? 'text-blue-600' : 'text-orange-600'}">
          <i class="fa-solid ${isA ? 'fa-glasses' : 'fa-brain'}"></i>
          <span class="font-bold text-sm">${isA ? 'Grammar Guru' : 'Logic Master'}</span>
        </div>
        <div class="text-sm text-gray-700 markdown-body">${marked.parse(content)}</div>
      `;
            container.appendChild(div);
        }

        // ── Chat ──────────────────────────────────────────────────────────────────
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg || !currentSessionId) return;

            const chatHtml = `
        <div class="mt-4 border-t pt-4">
          <p class="font-bold text-indigo-600 mb-1">Me:</p>
          <p class="bg-indigo-50 p-2 rounded text-sm mb-2">${msg}</p>
          <p class="font-bold text-gray-800 mb-1">Examiner:</p>
          <div class="response-area text-sm text-gray-700 markdown-body"><i class="fa-solid fa-ellipsis fa-fade"></i></div>
        </div>
      `;
            const cContent = document.querySelector('#agentC .content');
            cContent.innerHTML += chatHtml;
            input.value = '';

            const areas = cContent.querySelectorAll('.response-area');
            const currentArea = areas[areas.length - 1];

            contextHistory.push({ role: 'user', content: msg });

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSessionId, messages: contextHistory })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                contextHistory.push({ role: 'assistant', content: data.reply });
                currentArea.innerHTML = marked.parse(data.reply);
            } catch (e) {
                currentArea.innerHTML = `<span class="text-red-500">错误：${e.message}</span>`;
            }

            document.getElementById('processArea').scrollTo({ top: document.getElementById('processArea').scrollHeight, behavior: 'smooth' });
        }

        // Enter key for chat
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('chatInput').addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
            });
        });

        // ── Profile ───────────────────────────────────────────────────────────────
        function openProfileModal() {
            document.getElementById('prof-displayName').value = currentUser.display_name || '';
            document.getElementById('prof-oldPwd').value = '';
            document.getElementById('prof-newPwd').value = '';
            document.getElementById('profError').classList.add('hidden');
            document.getElementById('profSuccess').classList.add('hidden');
            document.getElementById('profileModal').classList.remove('hidden');
        }

        async function saveProfile() {
            const errEl = document.getElementById('profError');
            const sucEl = document.getElementById('profSuccess');
            errEl.classList.add('hidden');
            sucEl.classList.add('hidden');

            const body = { display_name: document.getElementById('prof-displayName').value.trim() };
            const newPwd = document.getElementById('prof-newPwd').value;
            if (newPwd) {
                body.old_password = document.getElementById('prof-oldPwd').value;
                body.new_password = newPwd;
            }

            const res = await fetch('/api/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await res.json();
            if (!res.ok) {
                errEl.textContent = data.error;
                errEl.classList.remove('hidden');
                return;
            }
            sucEl.classList.remove('hidden');
            currentUser.display_name = body.display_name;
            document.getElementById('userName').textContent = body.display_name || currentUser.username;
            document.getElementById('userAvatar').textContent = (body.display_name || currentUser.username)[0].toUpperCase();
        }

        // ── Helpers ───────────────────────────────────────────────────────────────
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        }

        init();
    </script>
</body>

</html>